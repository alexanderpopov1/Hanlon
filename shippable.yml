language: ruby

build_image: shippableimages/ubuntu1204_ruby:0.0.1

rvm:
  - 1.9.3
  
env:
 - TEST_MODE=true

before_install:
  - apt-get -y update -qq
  - source ~/.rvm/scripts/rvm
  - rvm install $SHIPPABLE_RUBY --verify-downloads 1
  - source ~/.bashrc && ~/.rvm/scripts/rvm && rvm use $SHIPPABLE_RUBY

install:
  - apt-get -y install build-essential
  - apt-get autoremove
  - apt-get clean
  - rm -rf /tmp/* /var/tmp/* /var/lib/apt/lists/*
  - bundle install

services:
  - mongodb

script:
  - ./hanlon_init
  - sed -i "s/127.0.0.1/$MONGO_PORT_27017_TCP_ADDR/g" web/config/hanlon_server.conf
  - ./web/run-puma.sh 2>&1 > /dev/null &
  - sleep 15
  - curl http://localhost:8026/hanlon/api/v1/node
  - sleep 15
  - cd test
  - rspec